#!/bin/bash
# secret-fetch - Fetch secrets from GCP Secret Manager
# Usage:
#   secret-fetch <secret-name>                      # Output single secret value
#   secret-fetch --env <name1> <name2> ...           # Output export statements
#   secret-fetch --list                              # List available secrets
#
# Environment variables:
#   GCP_PROJECT_ID            - GCP Project ID (required)
#   SECRET_MANAGER_PROJECT_ID - Override project for Secret Manager only

set -e

PROJECT_ID="${SECRET_MANAGER_PROJECT_ID:-${GCP_PROJECT_ID:-}}"

if [ -z "$PROJECT_ID" ]; then
    echo "Error: GCP_PROJECT_ID or SECRET_MANAGER_PROJECT_ID is required" >&2
    exit 1
fi

# --- List mode ---
if [ "${1:-}" = "--list" ]; then
    gcloud secrets list --project="$PROJECT_ID" --format="table(name.basename(), createTime.date(), replicationType)" 2>/dev/null
    exit $?
fi

# --- Env mode (export statements) ---
if [ "${1:-}" = "--env" ]; then
    shift
    if [ $# -eq 0 ]; then
        echo "Error: Specify secret names after --env" >&2
        exit 1
    fi
    FAILED=0
    for SECRET_NAME in "$@"; do
        VALUE=$(gcloud secrets versions access latest --secret="$SECRET_NAME" --project="$PROJECT_ID" 2>/dev/null)
        if [ $? -eq 0 ] && [ -n "$VALUE" ]; then
            # Single-quote the value to prevent shell expansion
            printf "export %s='%s'\n" "$SECRET_NAME" "$(echo "$VALUE" | sed "s/'/'\\\\''/g")"
        else
            echo "# WARN: Failed to fetch $SECRET_NAME" >&2
            FAILED=1
        fi
    done
    exit $FAILED
fi

# --- Single secret mode ---
SECRET_NAME="${1:-}"
if [ -z "$SECRET_NAME" ]; then
    echo "Error: Secret name is required" >&2
    echo "Usage: secret-fetch <secret-name>" >&2
    echo "       secret-fetch --env <name1> <name2> ..." >&2
    echo "       secret-fetch --list" >&2
    exit 1
fi

gcloud secrets versions access latest --secret="$SECRET_NAME" --project="$PROJECT_ID" 2>/dev/null
if [ $? -ne 0 ]; then
    echo "Error: Failed to fetch secret '$SECRET_NAME' from project '$PROJECT_ID'" >&2
    exit 1
fi
