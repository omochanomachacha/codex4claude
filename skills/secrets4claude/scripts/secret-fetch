#!/bin/bash
# secret-fetch - Fetch secrets from GCP Secret Manager
# Usage:
#   secret-fetch <secret-name>                      # Output single secret value
#   secret-fetch --env <name1> <name2> ...           # Output export statements
#   secret-fetch --bundle <bundle-name>              # Output export statements for a predefined bundle
#
# Bundles:
#   openai  - OPENAI_API_KEY, OPENAI_ORGANIZATION_ID, OPENAI_PROJECT_ID
#
# Environment variables:
#   GCP_PROJECT_ID            - GCP Project ID (required)
#   SECRET_MANAGER_PROJECT_ID - Override project for Secret Manager only
#
# NOTE: This script uses direct secret access only (secretAccessor role).
#       List operations are not supported (no secretmanager.list permission).

set -e

PROJECT_ID="${SECRET_MANAGER_PROJECT_ID:-${GCP_PROJECT_ID:-}}"

if [ -z "$PROJECT_ID" ]; then
    echo "Error: GCP_PROJECT_ID or SECRET_MANAGER_PROJECT_ID is required" >&2
    exit 1
fi

# --- Bundle resolver ---
resolve_bundle() {
    case "$1" in
        openai)
            echo "OPENAI_API_KEY OPENAI_ORGANIZATION_ID OPENAI_PROJECT_ID"
            ;;
        *)
            echo ""
            ;;
    esac
}

# --- Helper: fetch and export multiple secrets ---
fetch_and_export() {
    local FAILED=0
    for SECRET_NAME in "$@"; do
        VALUE=$(gcloud secrets versions access latest --secret="$SECRET_NAME" --project="$PROJECT_ID" 2>/dev/null) || true
        if [ -n "$VALUE" ]; then
            printf "export %s='%s'\n" "$SECRET_NAME" "$(echo "$VALUE" | sed "s/'/'\\\\''/g")"
        else
            echo "# WARN: Failed to fetch $SECRET_NAME" >&2
            FAILED=1
        fi
    done
    return $FAILED
}

# --- Bundle mode ---
if [ "${1:-}" = "--bundle" ]; then
    BUNDLE_NAME="${2:-}"
    if [ -z "$BUNDLE_NAME" ]; then
        echo "Error: Specify bundle name after --bundle" >&2
        echo "Available bundles: openai" >&2
        exit 1
    fi
    SECRETS=$(resolve_bundle "$BUNDLE_NAME")
    if [ -z "$SECRETS" ]; then
        echo "Error: Unknown bundle '$BUNDLE_NAME'" >&2
        echo "Available bundles: openai" >&2
        exit 1
    fi
    # shellcheck disable=SC2086
    fetch_and_export $SECRETS
    exit $?
fi

# --- Env mode (export statements) ---
if [ "${1:-}" = "--env" ]; then
    shift
    if [ $# -eq 0 ]; then
        echo "Error: Specify secret names after --env" >&2
        exit 1
    fi
    fetch_and_export "$@"
    exit $?
fi

# --- Single secret mode ---
SECRET_NAME="${1:-}"
if [ -z "$SECRET_NAME" ]; then
    echo "Error: Secret name is required" >&2
    echo "Usage: secret-fetch <secret-name>" >&2
    echo "       secret-fetch --env <name1> <name2> ..." >&2
    echo "       secret-fetch --bundle openai" >&2
    exit 1
fi

VALUE=$(gcloud secrets versions access latest --secret="$SECRET_NAME" --project="$PROJECT_ID" 2>/dev/null) || true
if [ -n "$VALUE" ]; then
    echo "$VALUE"
else
    echo "Error: Failed to fetch secret '$SECRET_NAME' from project '$PROJECT_ID'" >&2
    exit 1
fi
